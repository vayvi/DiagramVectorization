
# 
This repository has code for performing line and circle detection over images using a two-step process. The first step is edge detection. The second is the RANSAC algorithm over the obtained contour image.  
This code is the baseline part of an implementation for the IAMAHA conference presentation on the vectorization of historical diagram.

## Install 

Create a conda environment 
```
conda create --name <env_name> --file requirements.txt
```

This code has a local package for easier navigation. In order to install the local package *ransac*, first go to the baseline folder then install: 
```
cd baseline
pip install -e .
```

## Preprocessing

### Resizing

For faster computation and standardization purposes, png images are resized keeping the same aspect ratio so that the height and width are at most 1000 pixels. If there are SVG annotations for these images, they will be rescaled accordingly during evaluation. The input folder is assumed to be in data/diagrams/images. It can be changed by changing the INPUT_DATADIR variable in the ransac package.
To launch image resizing, launch
```
python scripts/resize_inputs.py 
```


### Generating text masks (optional)

An optional step to get less noisy contours is text detection. This can be done using TESTR: [Text Spotting Transformers](https://openaccess.thecvf.com/content/CVPR2022/html/Zhang_Text_Spotting_Transformers_CVPR_2022_paper.html). This network is favored because it can detect curved instances of text. TESTR can be used out of the box, we therefore do not include the code in this repository. Please refer to [the official repository](https://github.com/mlpc-ucsd/TESTR) for installation. 
The demo can be used to generate the text masks over the resized image. 


## Edge detection
Edges are computed using canny, they can be generated by launching: 

 ```
python scripts/generate_contour_images.py --input_folder images_resized --output_folder edged_resized
 ```

If you have text masks available in folder data/diagrams/image_text_masks, you can generate contours without masks using:  
 
 ```
python scripts/generate_contour_images.py --input_folder images_resized --text_mask_folder images_resized_testr_mask --output_folder edges_resized_testr
 ```



## RANSAC predictions

### Generating predictions
In order to be able to load predictions for evaluation, predicted lines and circles are stored as .pkl when generating the predictions. 
You can generate predictions by launching 

```
python scripts/generate_predictions.py --config_path config/config_baseline.yaml --save_plots
```
If you have access to text masks you can launch

```
python scripts/generate_predictions.py --config_path config/config_baseline_no_testr.yaml --save_plots
```
### Evaluation
Groud-truth annotations are automatically resized to the image's height and width.
If you have ground-truth svgs and would like to evaluate the method, you can add the additional arugment --evaluate to the previous command. 
<!-- In this case, make sure the image and svg share the same name, we use the -corr suffix for ground-truth and keep files in data/diagrams/svgs. -->

Or, you can launch evalutation after generating the predicitons by running: 

```
python scritps/evaluate.py  
```


<!-- for me only -->
<!-- In order to extract text from the images , go to the testr directory and activate test-testr then launch: 
 ```
 python demo/demo.py --input /home/kallelis/PrimitiveExtraction/PrimitiveExtraction/data/real_diagrams_raw/images_resized --output /home/kallelis/PrimitiveExtraction/PrimitiveExtraction/data/real_diagrams_raw/images_resized_testr --output-mask /home/kallelis/PrimitiveExtraction/PrimitiveExtraction/data/real_diagrams_raw/images_resized_testr_mask --config-file configs/TESTR/TotalText/TESTR_R_50_Polygon.yaml
```
  -->
<!-- TODO: make this a bash script asap  -->

